// å˜é‡ç»‘å®š
const fileInput = document.getElementById("file-input");
const dropZone = document.getElementById("drag-drop-zone");
const contractText = document.getElementById("contract-text");
const riskCards = document.getElementById("risk-cards");
const chatInput = document.getElementById("chat-input");
const sendChatBtn = document.getElementById("send-chat");
const chatLog = document.getElementById("chat-log");
const statusArea = document.getElementById("status-area");
const togglePreviewBtn = document.getElementById("toggle-preview");
const toggleChatLogBtn = document.getElementById("toggle-chat-log");

let fullContractText = "";
let riskKeywords = [];

// DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener("DOMContentLoaded", function () {
  // æ–‡ä»¶å¤„ç†
  function handleFile(file) {
    const fileType = file.name.split(".").pop().toLowerCase();

    if (fileType === "txt") {
      const reader = new FileReader();
      reader.onload = function (e) {
        fullContractText = e.target.result;
        showRiskAnalysis(fullContractText);
        updatePreview(fullContractText);
        statusArea.textContent = "âœ… åˆåŒå·²ä¸Šä¼ ï¼ˆTXTï¼‰";
      };
      reader.readAsText(file);
    } else if (fileType === "pdf") {
      const reader = new FileReader();
      reader.onload = async function (e) {
        const typedArray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(" ") + "\n";
        }
        fullContractText = text;
        showRiskAnalysis(fullContractText);
        updatePreview(fullContractText);
        statusArea.textContent = "âœ… åˆåŒå·²ä¸Šä¼ ï¼ˆPDFï¼‰";
      };
      reader.readAsArrayBuffer(file);
    } else if (fileType === "docx") {
      const reader = new FileReader();
      reader.onload = function (e) {
        mammoth.extractRawText({ arrayBuffer: e.target.result })
          .then(result => {
            fullContractText = result.value;
            showRiskAnalysis(fullContractText);
            updatePreview(fullContractText);
            statusArea.textContent = "âœ… åˆåŒå·²ä¸Šä¼ ï¼ˆDOCXï¼‰";
          })
          .catch(err => {
            statusArea.textContent = "âŒ è§£æ DOCX æ–‡ä»¶å¤±è´¥ï¼š" + err.message;
          });
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert("âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼  .txtã€.pdf æˆ– .docx æ ¼å¼çš„åˆåŒã€‚");
      statusArea.textContent = "âŒ ä¸Šä¼ å¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹";
    }
  }

  // é«˜äº®å…³é”®è¯
  function highlightKeywords(text, keywords) {
    if (!keywords.length) return text;
    const escapedKeywords = keywords.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    const pattern = new RegExp(`(${escapedKeywords.join("|")})`, "gi");
    return text.replace(pattern, '<mark>$1</mark>');
  }

  // é¢„è§ˆæ›´æ–°ï¼ˆå¸¦é«˜äº®ï¼‰
  function updatePreview(text) {
    const highlighted = highlightKeywords(text, riskKeywords);
    contractText.innerHTML = highlighted || "å°šæœªä¸Šä¼ åˆåŒ";
    contractText.style.maxHeight = "200px";
    togglePreviewBtn.textContent = "å±•å¼€";
  }

  // é£é™©æç¤ºå¹¶æå–å…³é”®è¯
  function showRiskAnalysis(text) {
    riskCards.innerHTML = "";
    riskKeywords = [];

    const risks = [
      { keywords: ["è¯•ç”¨æœŸ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸâ€æ¡æ¬¾ï¼Œè¯·æ³¨æ„è¯•ç”¨æœŸé•¿åº¦ã€è–ªèµ„åŠè§£é™¤åˆåŒæ¡ä»¶æ˜¯å¦åˆç†ã€‚" },
      { keywords: ["èµ”å¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œèµ”å¿â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„èµ”å¿è´£ä»»æ˜¯å¦å…¬å¹³ï¼Œé‡‘é¢æ˜¯å¦è¿‡é«˜ã€‚" },
      { keywords: ["ç«ä¸šé™åˆ¶"], message: "âš ï¸ æ£€æµ‹åˆ°â€œç«ä¸šé™åˆ¶â€æ¡æ¬¾ï¼Œå¯èƒ½é™åˆ¶ä½ ç¦»èŒåçš„å·¥ä½œè‡ªç”±ï¼Œè¯·ç¡®è®¤èŒƒå›´å’Œè¡¥å¿ã€‚" },
      { keywords: ["ä¿å¯†åè®®"], message: "âš ï¸ æ£€æµ‹åˆ°â€œä¿å¯†åè®®â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„ä¿å¯†ä¹‰åŠ¡çš„èŒƒå›´å’ŒæœŸé™æ˜¯å¦åˆç†ã€‚" },
      { keywords: ["çŸ¥è¯†äº§æƒ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œçŸ¥è¯†äº§æƒâ€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ä¸ªäººåˆ›ä½œçš„çŸ¥è¯†äº§æƒå½’å±æ˜¯å¦è¢«æ— å¿è½¬è®©ã€‚" },
      { keywords: ["è¿çº¦é‡‘"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¿çº¦é‡‘â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„é‡‘é¢æ˜¯å¦è¿‡é«˜ï¼Œæ˜¯å¦ç¬¦åˆæ³•å¾‹è§„å®šã€‚" },
      { keywords: ["åŠ³åŠ¨åˆåŒæœŸé™"], message: "âš ï¸ æ£€æµ‹åˆ°â€œåŠ³åŠ¨åˆåŒæœŸé™â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„åˆåŒæœŸé™æ˜¯å¦åˆç†ï¼Œæ˜¯å¦å­˜åœ¨å¼ºåˆ¶ç»­ç­¾ã€‚" },
      { keywords: ["å·¥ä½œåœ°ç‚¹"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå·¥ä½œåœ°ç‚¹â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤å·¥ä½œåœ°ç‚¹æ˜¯å¦æ˜ç¡®ï¼Œæ˜¯å¦å­˜åœ¨éšæ„è°ƒå²—é£é™©ã€‚" },
      { keywords: ["å·¥ä½œå†…å®¹"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå·¥ä½œå†…å®¹â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„èŒè´£èŒƒå›´æ˜¯å¦æ¸…æ™°ï¼Œé¿å…è¶…è´Ÿè·å·¥ä½œã€‚" },
      { keywords: ["è–ªèµ„å¾…é‡"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè–ªèµ„å¾…é‡â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„è–ªèµ„æ„æˆã€æ”¯ä»˜æ—¶é—´åŠæ‰£æ¬¾æ¡æ¬¾æ˜¯å¦é€æ˜ã€‚" },
      { keywords: ["åŠ ç­"], message: "âš ï¸ æ£€æµ‹åˆ°â€œåŠ ç­â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤åŠ ç­è´¹æ ‡å‡†åŠæ˜¯å¦å¼ºåˆ¶æ— å¿åŠ ç­ã€‚" },
      { keywords: ["ç¦åˆ©å¾…é‡"], message: "âš ï¸ æ£€æµ‹åˆ°â€œç¦åˆ©å¾…é‡â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„ç¤¾ä¿ã€å…¬ç§¯é‡‘ç­‰ç¦åˆ©æ˜¯å¦æ˜ç¡®è½å®ã€‚" },
      { keywords: ["è§£é™¤åˆåŒ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè§£é™¤åˆåŒâ€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤è§£é™¤æ¡ä»¶å’Œç¨‹åºæ˜¯å¦å…¬å¹³ï¼Œæ˜¯å¦å­˜åœ¨å•æ–¹è§£é™¤æƒã€‚" },
      { keywords: ["äº‰è®®è§£å†³"], message: "âš ï¸ æ£€æµ‹åˆ°â€œäº‰è®®è§£å†³â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„äº‰è®®è§£å†³æ–¹å¼å’Œåœ°ç‚¹æ˜¯å¦å¯¹ä½ ä¸åˆ©ã€‚" },
      { keywords: ["ä¸å¯æŠ—åŠ›"], message: "âš ï¸ æ£€æµ‹åˆ°â€œä¸å¯æŠ—åŠ›â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ä¸å¯æŠ—åŠ›å®šä¹‰åŠå¤„ç†æ–¹å¼æ˜¯å¦æ¸…æ™°ã€‚" },
      { keywords: ["è‡ªåŠ¨ç»­æœŸ", "è‡ªåŠ¨ç»­ç­¾"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè‡ªåŠ¨ç»­æœŸâ€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦æ˜ç¡®å‘ŠçŸ¥åŠæ˜¯å¦å­˜åœ¨å•æ–¹é¢ç»­çº¦çš„é£é™©ã€‚" },
      { keywords: ["è¯•ç”¨æœŸä¸åˆæ ¼", "è¯•ç”¨æœŸè§£é™¤"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸè§£é™¤â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤è§£é™¤æ¡ä»¶æ˜¯å¦æ¨¡ç³Šæˆ–æ˜“è¢«æ»¥ç”¨ã€‚" },
      { keywords: ["è°ƒå²—", "å²—ä½è°ƒæ•´"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè°ƒå²—â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦èµ‹äºˆç”¨äººå•ä½è¿‡å¤§çš„è°ƒå²—æƒåˆ©ï¼Œæ˜¯å¦å½±å“è–ªé…¬å¾…é‡ã€‚" },
      { keywords: ["æœªç­¾è®¢ä¹¦é¢åˆåŒ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œæœªç­¾è®¢ä¹¦é¢åˆåŒâ€ç›¸å…³è¡¨è¿°ï¼Œè¯·æ³¨æ„å…¥èŒååº”å°½å¿«ç­¾ç½²ä¹¦é¢åˆåŒä»¥ä¿éšœæƒç›Šã€‚" },
      { keywords: ["åŸ¹è®­æœåŠ¡æœŸ", "æœåŠ¡æœŸè¿çº¦é‡‘"], message: "âš ï¸ æ£€æµ‹åˆ°â€œåŸ¹è®­æœåŠ¡æœŸâ€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æœåŠ¡æœŸæ—¶é•¿ä¸è¿çº¦è´£ä»»æ˜¯å¦åˆç†ã€‚" },
      { keywords: ["å·¥ä¼¤è´£ä»»"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå·¥ä¼¤è´£ä»»â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å­˜åœ¨æ¨å¸æ³•å®šå·¥ä¼¤èµ”å¿è´£ä»»çš„è¡¨è¿°ã€‚" },
      { keywords: ["è¯•ç”¨æœŸå·¥èµ„ä½äºæ ‡å‡†"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸå·¥èµ„â€ç›¸å…³æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä½äºæœ€ä½å·¥èµ„æ ‡å‡†æˆ–æœªæ˜ç¡®å·¥èµ„æ°´å¹³ã€‚" },
      { keywords: ["å•æ–¹å˜æ›´", "å…¬å¸æœ‰æƒéšæ—¶å˜æ›´"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå•æ–¹å˜æ›´â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å…è®¸å…¬å¸éšæ„å˜æ›´åˆåŒæ¡æ¬¾æˆ–å·¥ä½œæ¡ä»¶ã€‚" },
      { keywords: ["åŠ³åŠ¨å…³ç³»è®¤å®š"], message: "âš ï¸ æ£€æµ‹åˆ°â€œåŠ³åŠ¨å…³ç³»è®¤å®šâ€ç›¸å…³è¡¨è¿°ï¼Œè¯·è­¦æƒ•æ˜¯å¦è§„é¿æ­£å¼åŠ³åŠ¨å…³ç³»ã€è½¬ä¸ºå¤–åŒ…æˆ–åŠ³åŠ¡æ´¾é£ã€‚" },
      { keywords: ["å¤–åŒ…", "æ´¾é£"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå¤–åŒ…/æ´¾é£â€ç›¸å…³æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ä½ ä¸è°å»ºç«‹åŠ³åŠ¨å…³ç³»åŠå…¶åˆæ³•æ€§ã€‚" },
      { keywords: ["æœªç¼´çº³ç¤¾ä¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œæœªç¼´çº³ç¤¾ä¿â€è¡¨è¿°ï¼Œè¯·æ³¨æ„æ˜¯å¦è¿åæ³•å¾‹è§„å®šï¼Œå½±å“æœªæ¥ç¦åˆ©å¾…é‡ã€‚" },
      { keywords: ["è¯•ç”¨æœŸå»¶é•¿", "é‡æ–°è®¡ç®—è¯•ç”¨æœŸ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸå»¶é•¿â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦è¿åã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹è§„å®šçš„æœ€é•¿æœŸé™ã€‚" },
      { keywords: ["è¯•ç”¨æœŸå»¶é•¿", "è½¬æ­£æ—¶é—´å»¶æœŸ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸå»¶é•¿â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦å­˜åœ¨æ— æ­£å½“ç†ç”±å»¶é•¿è½¬æ­£æ—¶é—´çš„æƒ…å½¢ã€‚" },
      { keywords: ["ç¤¾ä¿è‡ªæ„¿", "è‡ªè¡Œç¼´çº³ç¤¾ä¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè‡ªè¡Œç¼´çº³ç¤¾ä¿â€è¡¨è¿°ï¼Œè¯·æ³¨æ„ä¼ä¸šæ˜¯å¦è¿åæ³•å®šä¹‰åŠ¡è½¬å«ç¤¾ä¿è´£ä»»ã€‚" },
      { keywords: ["å…¼èŒé™åˆ¶", "ä¸å¾—ä»äº‹å…¶ä»–å·¥ä½œ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå…¼èŒé™åˆ¶â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦åˆç†é™åˆ¶ä½ çš„ä¸šä½™æ—¶é—´è‡ªç”±æƒåˆ©ã€‚" },
      { keywords: ["è¯•ç”¨æœŸä¸ç¼´ç¤¾ä¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸä¸ç¼´ç¤¾ä¿â€è¡¨è¿°ï¼Œè¯·æ³¨æ„è¯¥è¡Œä¸ºè¿åæ³•å¾‹è§„å®šï¼Œå½±å“æƒç›Šã€‚" },
      { keywords: ["å²—ä½èŒè´£ä»¥å…¬å¸å®‰æ’ä¸ºå‡†"], message: "âš ï¸ æ£€æµ‹åˆ°â€œèŒè´£ä»¥å®‰æ’ä¸ºå‡†â€ç±»è¡¨è¿°ï¼Œå¯èƒ½å¯¼è‡´èŒè´£èŒƒå›´ä¸æ˜ç¡®ï¼Œå­˜åœ¨ä¸´æ—¶å®‰æ’é£é™©ã€‚" },
      { keywords: ["ä¿åº•å·¥èµ„", "ç»©æ•ˆå·¥èµ„ä¸è¾¾æ ‡"], message: "âš ï¸ æ£€æµ‹åˆ°â€œä¿åº•å·¥èµ„â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ç»©æ•ˆè€ƒæ ¸æ ‡å‡†æ˜¯å¦æ˜ç¡®ï¼Œæ˜¯å¦ä»¥æ­¤è§„é¿å·¥èµ„ä¹‰åŠ¡ã€‚" },
      { keywords: ["ç¦»èŒæå‰é€šçŸ¥", "é€šçŸ¥æœŸ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œç¦»èŒé€šçŸ¥æœŸâ€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦è¶…è¿‡ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹è§„å®šçš„æå‰30å¤©ã€‚" },
      { keywords: ["ç»æµæ€§è£å‘˜", "ç»“æ„è°ƒæ•´"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè£å‘˜â€ç›¸å…³æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦èµ‹äºˆå…¬å¸å•æ–¹è£å‘˜çš„è‡ªç”±æƒåˆ©ï¼Œè¿åæ³•å¾‹ç¨‹åºã€‚" },
      { keywords: ["è‡ªæ„¿æ”¾å¼ƒ", "æƒåˆ©æ”¾å¼ƒå£°æ˜"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè‡ªæ„¿æ”¾å¼ƒæƒåˆ©â€ç±»æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å­˜åœ¨å¼ºè¿«å‘˜å·¥æ”¾å¼ƒæ³•å®šæƒåˆ©çš„æƒ…å†µã€‚" },
      { keywords: ["å£å¤´é€šçŸ¥ä¸ºå‡†", "å…¬å¸å†…éƒ¨è§„å®šä¼˜å…ˆ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œä»¥å£å¤´æˆ–å†…éƒ¨åˆ¶åº¦ä¸ºå‡†â€çš„æ¡æ¬¾ï¼Œå¯èƒ½å‰Šå¼±æ­£å¼åˆåŒæ•ˆåŠ›ï¼Œè¯·è°¨æ…å¤„ç†ã€‚" },
      { keywords: ["å…¬å¸æ‹¥æœ‰æœ€ç»ˆè§£é‡Šæƒ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œæœ€ç»ˆè§£é‡Šæƒå½’å…¬å¸æ‰€æœ‰â€æ¡æ¬¾ï¼Œå¯èƒ½å¯¼è‡´åˆåŒä¸å¯¹ç­‰ï¼Œåº”å¼•èµ·è­¦æƒ•ã€‚" },
      { keywords: ["é»˜è®¤åŒæ„", "è§†ä¸ºåŒæ„"], message: "âš ï¸ æ£€æµ‹åˆ°â€œé»˜è®¤åŒæ„â€ç±»æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å­˜åœ¨æœªå……åˆ†å‘ŠçŸ¥å³æ¨å®šä½ åŒæ„çš„é£é™©ã€‚" },
      { keywords: ["è¯•ç”¨æœŸä¸åˆæ ¼ä¸äºˆèµ”å¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè¯•ç”¨æœŸè§£é™¤ä¸èµ”å¿â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¾æ³•è¯´æ˜ä¸åˆæ ¼çš„å…·ä½“æ ‡å‡†ã€‚" },
      { keywords: ["ç»©æ•ˆè€ƒæ ¸æ ‡å‡†æœªå®š", "ç»©æ•ˆç”±å…¬å¸å†³å®š"], message: "âš ï¸ æ£€æµ‹åˆ°â€œç»©æ•ˆè€ƒæ ¸ä¸é€æ˜â€æ¡æ¬¾ï¼Œç»©æ•ˆä¸æ˜ç¡®å¯èƒ½å½±å“æ”¶å…¥å’Œè€ƒæ ¸å…¬å¹³æ€§ã€‚" },
      { keywords: ["è§†åŒè‡ªåŠ¨ç¦»èŒ", "è§†ä¸ºç¦»èŒ"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè§†ä¸ºè‡ªåŠ¨ç¦»èŒâ€è¡¨è¿°ï¼Œå®¹æ˜“è¢«æ»¥ç”¨è§„é¿è§£é™¤ç¨‹åºï¼Œè¯·è°¨æ…è¯„ä¼°ã€‚" },
      { keywords: ["å…¬å¸å®‰æ’ä½å®¿", "ä½å®¿è´¹ç”¨è‡ªç†"], message: "âš ï¸ æ£€æµ‹åˆ°â€œä½å®¿å®‰æ’â€ç›¸å…³æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦å­˜åœ¨å¼ºåˆ¶ä½å®¿æˆ–éšæ€§æ‰£è´¹é£é™©ã€‚" },
      { keywords: ["å‘˜å·¥é¡»æœä»å®‰æ’", "ä¸€åˆ‡è§£é‡Šæƒå½’å…¬å¸"], message: "âš ï¸ æ£€æµ‹åˆ°â€œç»å¯¹æœä»â€æˆ–â€œè§£é‡Šæƒå½’å…¬å¸â€è¡¨è¿°ï¼Œå¯èƒ½ä¾µçŠ¯å‘˜å·¥çš„å¹³ç­‰åå•†æƒåˆ©ã€‚" },
      { keywords: ["åè®®ä¼˜å…ˆ", "è¡¥å……åè®®ä¸ºå‡†"], message: "âš ï¸ æ£€æµ‹åˆ°â€œåè®®ä¼˜å…ˆâ€ç±»æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦å­˜åœ¨å¯¹ä¸»åˆåŒä¸åˆ©çš„è¡¥å……åè®®å†…å®¹ã€‚" },
      { keywords: ["å·¥èµ„å»¶æœŸ", "é¡¹ç›®ç»“æŸåæ”¯ä»˜"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå·¥èµ„å»¶æœŸå‘æ”¾â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤å·¥èµ„å‘æ”¾æ—¶é—´æ˜¯å¦è¿åæŒ‰æœˆæ”¯ä»˜è§„å®šã€‚" },
      { keywords: ["ä¸å±å·¥ä¼¤", "è‡ªè¡Œè´Ÿè´£"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè´£ä»»è‡ªè¡Œæ‰¿æ‹…â€ç±»è¡¨è¿°ï¼Œå­˜åœ¨è§„é¿æ³•å®šå·¥ä¼¤èµ”å¿çš„é£é™©ã€‚" },
      { keywords: ["å·¥æ—¶ç”±å…¬å¸å†³å®š", "å·¥ä½œæ—¶é—´çµæ´»è°ƒæ•´"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå·¥æ—¶ç”±å…¬å¸å®‰æ’â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦æ©ç›–æ— å¿åŠ ç­é£é™©ã€‚" },
      { keywords: ["éšç§ç›‘æ§", "é‚®ä»¶æ£€æŸ¥"], message: "âš ï¸ æ£€æµ‹åˆ°â€œéšç§ç›‘æ§â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦ä¾µçŠ¯ä¸ªäººé€šè®¯åŠéšç§æƒã€‚" },
      { keywords: ["æå‰ç¦»èŒé¡»èµ”å¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œæå‰ç¦»èŒéœ€èµ”å¿â€è¡¨è¿°ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸å®é™…æŸå¤±æŒ‚é’©ï¼Œæ˜¯å¦è¿‡åº¦æƒ©ç½šã€‚" },
      { keywords: ["ä¿åº•ä»»åŠ¡", "æœªå®Œæˆä»»åŠ¡éœ€èµ”å¿"], message: "âš ï¸ æ£€æµ‹åˆ°â€œä¿åº•ä»»åŠ¡â€ç±»æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ä»»åŠ¡é‡æ˜¯å¦åˆç†ï¼Œè¿çº¦è´£ä»»æ˜¯å¦å¯¹ç­‰ã€‚" },
      { keywords: ["åˆåŒè§£é‡Šæƒå½’å±", "å…¬å¸è§£é‡Šä¸ºå‡†"], message: "âš ï¸ æ£€æµ‹åˆ°â€œè§£é‡Šæƒå½’å…¬å¸â€æ¡æ¬¾ï¼Œå¯èƒ½åœ¨äº§ç”Ÿäº‰è®®æ—¶å¯¹ä½ ä¸åˆ©ã€‚" },
      { keywords: ["åŠ³åŠ¨å…³ç³»ä¸æˆç«‹", "åˆä½œå…³ç³»"], message: "âš ï¸ æ£€æµ‹åˆ°â€œéåŠ³åŠ¨å…³ç³»â€è¡¨è¿°ï¼Œè­¦æƒ•å°†æ­£å¼åŠ³åŠ¨å…³ç³»ä¼ªè£…ä¸ºåˆä½œæˆ–æ‰¿æ½å…³ç³»ã€‚" },
      { keywords: ["å…ˆè¯•å²—", "å…ˆå®ä¹ åç­¾çº¦"], message: "âš ï¸ æ£€æµ‹åˆ°â€œå…ˆè¯•å²—/å®ä¹ â€ç±»æ¡æ¬¾ï¼Œè¯·ç¡®è®¤è¯•å²—æ˜¯å¦å­˜åœ¨å·¥èµ„æŠ¥é…¬åŠåˆæ³•æµç¨‹ã€‚" },
      {
    keywords: ["æŠ¥ä»·ç¡®è®¤å•ä¸ºå‡†", "ä»¥ç”²æ–¹ç­¾å­—ç›–ç« çš„æŠ¥ä»·ç¡®è®¤å•ä¸ºå‡†"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œå•æ–¹ç¡®è®¤ä»·æ ¼â€ä¸ºå‡†çš„æ¡æ¬¾ï¼Œä¹™æ–¹åœ¨è®®ä»·å’Œå±¥çº¦ä¸­å¤„äºè¢«åŠ¨åœ°ä½ï¼Œå­˜åœ¨ä»·æ ¼ä¸å¯¹ç­‰é£é™©ã€‚"
  },
  {
    keywords: ["å¦‚æœ‰ä¸ç¬¦åˆçš„æƒ…å†µï¼Œåº”äºˆä»¥æ•´æ”¹æˆ–æ›´æ¢ï¼Œå¹¶æ‰¿æ‹…ç”±æ­¤äº§ç”Ÿçš„ç›¸å…³è´¹ç”¨"],
    message: "âš ï¸ æ£€æµ‹åˆ°ç”²æ–¹å•æ–¹é¢è¦æ±‚æ•´æ”¹å¹¶æ‰¿æ‹…è´¹ç”¨çš„æ¡æ¬¾ï¼Œå»ºè®®æ˜ç¡®â€˜ä¸ç¬¦åˆâ€™çš„åˆ¤å®šæ ‡å‡†å’Œè´¹ç”¨è´£ä»»è¾¹ç•Œã€‚"
  },
  {
    keywords: ["æ£€æµ‹å·¥ä½œåº”åœ¨æŠ¥ä»·ç¡®è®¤å•çº¦å®šæœŸé™å†…å®Œæˆ", "å…·ä½“è¿›åœºæ—¶é—´ä»¥ç”²æ–¹é€šçŸ¥ä¸ºå‡†"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œä¹™æ–¹è¿›åœºæ—¶é—´å®Œå…¨ç”±ç”²æ–¹é€šçŸ¥å†³å®šâ€çš„æ¡æ¬¾ï¼Œä¹™æ–¹å±¥çº¦è®¡åˆ’å¯èƒ½å—åˆ¶äºç”²æ–¹ä¸´æ—¶å®‰æ’ï¼Œå­˜åœ¨è°ƒåº¦åŠè¿çº¦é£é™©ã€‚"
  },
  {
    keywords: ["ç”²æ–¹å§”æ‰˜è¶…å‡ºä¹™æ–¹æ£€æµ‹èŒƒå›´", "ä¹™æ–¹åº”æå‰å‘ŠçŸ¥ç”²æ–¹åˆ†åŒ…ç›¸å…³äº‹å®œ"],
    message: "âš ï¸ æ£€æµ‹åˆ°åˆ†åŒ…æ¡æ¬¾æœªæ˜ç¡®åˆ†åŒ…ä¸Šé™åŠè´£ä»»åˆ’åˆ†ï¼Œå¯èƒ½å¼•å‘æ£€æµ‹è´¨é‡äº‰è®®æˆ–è´£ä»»æ¨è¯¿é—®é¢˜ã€‚"
  },
  {
    keywords: ["ç”²æ–¹åº”åœ¨æ”¶åˆ°ä¹™æ–¹å‘ç¥¨å7ä¸ªå·¥ä½œæ—¥å†…ä¸€æ¬¡æ€§ç»“ç®—æ”¯ä»˜"],
    message: "âš ï¸ æ£€æµ‹åˆ°ç»“ç®—ä»˜æ¬¾æœŸé™ä¾èµ–äºç”²æ–¹ç­¾å­—ç¡®è®¤ï¼Œå»ºè®®é˜²èŒƒç”²æ–¹æ‹–å»¶ä»˜æ¬¾æˆ–æ‹’ç­¾é£é™©ã€‚"
  },
  {
    keywords: ["æ£€æµ‹è¿‡ç¨‹ä¸­ä»»ä½•å˜æ›´ï¼Œç”²æ–¹åº”æ”¯ä»˜å®é™…å·¥ä½œé‡è´¹ç”¨"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œå®é™…å·¥ä½œé‡â€ä½œä¸ºç»“ç®—ä¾æ®ä½†ç¼ºä¹å…·ä½“é‡åŒ–æ ‡å‡†ï¼Œå»ºè®®é˜²èŒƒç”²ä¹™åŒæ–¹å¯¹â€˜å˜æ›´â€™ç†è§£ä¸ä¸€è‡´çš„çº çº·ã€‚"
  },
  {
    keywords: ["ä¹™æ–¹æœ‰æƒåœæ­¢æœåŠ¡å¹¶ç•™ç½®æ ·å“ã€æŠ¥å‘ŠåŠèµ„æ–™"],
    message: "âš ï¸ æ£€æµ‹åˆ°ä¹™æ–¹å¯â€œç•™ç½®æ ·å“ã€æŠ¥å‘Šâ€çš„è¡¨è¿°ï¼Œå»ºè®®æ˜ç¡®ç•™ç½®èŒƒå›´åŠå½’è¿˜æ¡ä»¶ï¼Œé˜²æ­¢èµ„æ–™æµå¤±æˆ–çº çº·ã€‚"
  },
  {
    keywords: ["æŒ‰åº”ä»˜é‡‘é¢åƒåˆ†ä¹‹ä¸€çš„æ ‡å‡†æ”¶å–è¿çº¦é‡‘"],
    message: "âš ï¸ æ£€æµ‹åˆ°å¯¹ç”²æ–¹é€¾æœŸä»˜æ¬¾è¿çº¦é‡‘æ¡æ¬¾ï¼Œç¼ºå°‘å¯¹ä¹™æ–¹å»¶è¿Ÿå±¥çº¦çš„å¯¹ç­‰çº¦æŸï¼Œè¿çº¦è´£ä»»ä¸å¯¹ç­‰ã€‚"
  },
  {
    keywords: ["äº‰è®®æäº¤åŸå‘Šæ‰€åœ¨åœ°æ³•é™¢"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œäº‰è®®æäº¤åŸå‘Šæ‰€åœ¨åœ°â€æ¡æ¬¾ï¼Œå®¹æ˜“é€ æˆåœ°åŸŸç®¡è¾–ä¸å…¬ï¼Œå»ºè®®æ˜ç¡®ä»²è£æœºæ„æˆ–ä¸­ç«‹æ³•é™¢ã€‚"
  },
  {
    keywords: ["é™„ä»¶ä¸ºåˆåŒä¸€éƒ¨åˆ†", "å…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›"],
    message: "âš ï¸ æ£€æµ‹åˆ°é™„ä»¶æ–‡ä»¶å…·æ³•å¾‹æ•ˆåŠ›çš„è¡¨è¿°ï¼Œå»ºè®®é˜²èŒƒé™„ä»¶ä¿¡æ¯éšæ„ä¿®æ”¹æœªåŒæ­¥æ›´æ–°ä¸»åˆåŒçš„æ³•å¾‹é£é™©ã€‚"
  },
  {
    keywords: ["å»‰æ”¿åˆåŒ", "çºªæ£€ç›‘å¯Ÿå‘˜è´Ÿè´£ç›‘ç£"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œä¿å»‰åˆåŒâ€ç±»å†…å®¹ï¼Œå»ºè®®ç¡®è®¤å…¶å¯¹åˆåŒå±¥çº¦æµç¨‹æ˜¯å¦æ„æˆé¢å¤–å®¡æ‰¹æˆ–å»¶è¯¯ã€‚"
  },
  {
    keywords: ["æŠ¥ä»·ç¡®è®¤å•ä¸ºå‡†", "ç­¾å­—ç›–ç« çš„æŠ¥ä»·å•ä¸ºå‡†"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œæŠ¥ä»·ç¡®è®¤å•ä¸ºåˆåŒä¾æ®â€çš„æ¡æ¬¾ï¼Œè¯·ç¡®è®¤è¯¥é™„ä»¶æ˜¯å¦æ˜ç¡®ã€æ˜¯å¦å­˜åœ¨ç”²æ–¹å•æ–¹é¢å˜æ›´é£é™©ã€‚"
  },
  {
    keywords: ["æ£€æµ‹å·¥ä½œåº”åœ¨æŠ¥ä»·ç¡®è®¤å•çº¦å®šæœŸé™å†…å®Œæˆ", "ä»¥ç”²æ–¹é€šçŸ¥ä¸ºå‡†"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œå±¥çº¦æ—¶é—´ç”±ç”²æ–¹é€šçŸ¥å†³å®šâ€çš„æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å­˜åœ¨è¿›åœºæ—¶é—´ä¸ç¡®å®šã€å½±å“å±¥çº¦è®¡åˆ’çš„é£é™©ã€‚"
  },
  {
    keywords: ["ç”²æ–¹å‘ç°ä¸ç¬¦åˆè¦æ±‚åº”æ•´æ”¹", "æ•´æ”¹è´¹ç”¨ç”±ä¹™æ–¹æ‰¿æ‹…"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œæ•´æ”¹è´¹ç”¨ç”±ä¹™æ–¹æ‰¿æ‹…â€çš„æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ä¸ç¬¦åˆåˆ¤å®šæ ‡å‡†æ˜¯å¦æ˜ç¡®ï¼Œé¿å…æ‰¿æ‹…æ— è´£ä»»é£é™©ã€‚"
  },
  {
    keywords: ["åˆ†åŒ…éœ€ç”²æ–¹åŒæ„", "åˆ†åŒ…æ£€æµ‹é¡¹ç›®é¡»æå‰æŠ¥å¤‡"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œåˆ†åŒ…é¡»ç»æ‰¹å‡†â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦é™åˆ¶ä¹™æ–¹çµæ´»å±¥çº¦èƒ½åŠ›ï¼Œå¹¶æ³¨æ„åˆ†åŒ…è´£ä»»åˆ’åˆ†æ˜¯å¦æ¸…æ™°ã€‚"
  },
  {
    keywords: ["ä»˜æ¬¾æ¡ä»¶ä¸ºç”²æ–¹ç­¾å­—ç¡®è®¤", "ç»“ç®—éœ€å‘ç¥¨å’Œç¡®è®¤å•"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œä»˜æ¬¾ä¾èµ–ç”²æ–¹ç­¾å­—â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å­˜åœ¨ç”²æ–¹æ‹–å»¶ç­¾å­—ä»è€Œå»¶è¿Ÿä»˜æ¬¾çš„é£é™©ã€‚"
  },
  {
    keywords: ["å¦‚æ£€æµ‹é¡¹ç›®è°ƒæ•´ï¼Œåº”è¡¥å·®ä»·", "é¢å¤–å·¥ä½œå¦è¡Œè®¡è´¹"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œè°ƒæ•´å¦è®¡è´¹ç”¨â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„è´¹ç”¨æ ¸ç®—æ ‡å‡†æ˜¯å¦å…·ä½“ï¼Œæ˜¯å¦å­˜åœ¨æ”¶è´¹äº‰è®®ç©ºé—´ã€‚"
  },
  {
    keywords: ["ä¹™æ–¹å¯ç•™ç½®æŠ¥å‘Š", "åœæ­¢æœåŠ¡å¹¶ç•™ç½®èµ„æ–™"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œä¹™æ–¹å¯ç•™ç½®æŠ¥å‘Šâ€ç±»æ¡æ¬¾ï¼Œè¯·ç¡®è®¤å…¶åˆæ³•æ€§åŠæ˜¯å¦è¯´æ˜è¿”è¿˜æœºåˆ¶ï¼Œé¿å…èµ„æ–™è¢«æ»ç•™å½±å“é¡¹ç›®äº¤ä»˜ã€‚"
  },
  {
    keywords: ["è¿çº¦é‡‘ä¸ºåº”ä»˜æ¬¾åƒåˆ†ä¹‹ä¸€", "é€¾æœŸä»˜æ¬¾æ¯æ—¥åŠ æ”¶åƒåˆ†ä¹‹ä¸€"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œé€¾æœŸä»˜æ¬¾è¿çº¦é‡‘â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦ä¸ã€ŠåˆåŒæ³•ã€‹è§„å®šç›¸ç¬¦ï¼Œä»¥åŠæ˜¯å¦ç¼ºä¹å¯¹ä¹™æ–¹è¿çº¦çš„å¯¹ç­‰çº¦æŸã€‚"
  },
  {
    keywords: ["äº‰è®®ç”±åŸå‘Šæ‰€åœ¨åœ°æ³•é™¢å¤„ç†"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œäº‰è®®æŒ‰åŸå‘Šæ‰€åœ¨åœ°ç®¡è¾–â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„æ˜¯å¦å¯èƒ½å¯¼è‡´ä¸€æ–¹è¯‰è®¼æˆæœ¬ä¸åˆç†å¢åŠ ï¼Œå­˜åœ¨åœ°åŸŸä¸å…¬æ­£ã€‚"
  },
  {
    keywords: ["é™„ä»¶å…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›", "ä»¥é™„ä»¶ä¸ºå‡†"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œé™„ä»¶ä¸ºåˆåŒç»„æˆéƒ¨åˆ†â€æ¡æ¬¾ï¼Œè¯·æ³¨æ„é™„ä»¶æ˜¯å¦å†…å®¹å®Œæ•´ã€æ˜¯å¦å­˜åœ¨æ¨¡ç³Šæ€§æˆ–æœªç»ç¡®è®¤å³ç”Ÿæ•ˆçš„é£é™©ã€‚"
  },
  {
    keywords: ["ä¿å¯†åè®®å¦è¡Œç­¾ç½²", "ç­¾ç½²å»‰æ”¿åˆåŒ"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œéœ€ç­¾ç½²é¢å¤–åè®®â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤æ˜¯å¦å­˜åœ¨é™„åŠ ä¹‰åŠ¡æœªåœ¨ä¸»åˆåŒæ˜ç¡®ï¼Œå¯èƒ½å•æ–¹è§£é‡Šæ‰§è¡Œã€‚"
  },
  {
    keywords: ["å¦‚å‘ç”Ÿä¸å¯æŠ—åŠ›ï¼ŒåŒæ–¹åº”åå•†è§£å†³"],
    message: "âš ï¸ æ£€æµ‹åˆ°â€œä¸å¯æŠ—åŠ›â€æ¡æ¬¾ï¼Œè¯·ç¡®è®¤ä¸å¯æŠ—åŠ›çš„å®šä¹‰ã€æµç¨‹å’Œå…è´£èŒƒå›´æ˜¯å¦æ¸…æ™°ï¼Œé¿å…åç»­å±¥çº¦äº‰è®®ã€‚"
  }
    ];

    const detectedRisks = risks.filter(risk =>
      risk.keywords.some(keyword => text.toLowerCase().includes(keyword.toLowerCase()))
    );

    riskKeywords = detectedRisks.flatMap(r => r.keywords);

    if (detectedRisks.length > 0) {
      const box = document.createElement("div");
      box.className = "risk-box";
      const list = document.createElement("ul");
      detectedRisks.forEach(r => {
        const item = document.createElement("li");
        item.textContent = r.message;
        list.appendChild(item);
      });
      box.appendChild(list);
      riskCards.appendChild(box);
    } else {
      const noRisk = document.createElement("p");
      noRisk.className = "no-risk";
      noRisk.textContent = "æœªå‘ç°æ˜æ˜¾é£é™©æ¡æ¬¾";
      riskCards.appendChild(noRisk);
    }
  }

  // æ‹–æ‹½ä¸Šä¼ 
  dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.style.borderColor = "#005a9e";
  });
  dropZone.addEventListener("dragleave", () => {
    dropZone.style.borderColor = "#999";
  });
  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
    dropZone.style.borderColor = "#999";
  });

  // æ–‡ä»¶é€‰æ‹©ä¸Šä¼ 
  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  // å±•å¼€/æ”¶èµ·åˆåŒé¢„è§ˆåŒº
  togglePreviewBtn.addEventListener("click", () => {
    if (contractText.style.maxHeight === "200px" || contractText.style.maxHeight === "") {
      contractText.style.maxHeight = "none";
      togglePreviewBtn.textContent = "æ”¶èµ·";
    } else {
      contractText.style.maxHeight = "200px";
      togglePreviewBtn.textContent = "å±•å¼€";
    }
  });

  // AIå¯¹è¯åŠŸèƒ½ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
  sendChatBtn.addEventListener("click", async () => {
    const userMessage = chatInput.value.trim();
    if (!userMessage || !fullContractText) {
      alert("è¯·è¾“å…¥é—®é¢˜å¹¶ä¸Šä¼ åˆåŒæ–‡æœ¬");
      return;
    }

    const userBubble = document.createElement("p");
    userBubble.textContent = "ğŸ§‘ ä½ ï¼š" + userMessage;
    chatLog.appendChild(userBubble);

    chatInput.value = "";
    statusArea.textContent = "ğŸ¤– AI æ­£åœ¨æ€è€ƒä¸­...";

    try {
      const response = await fetch("https://contractgpt-worker.millychck-033.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contract: fullContractText, question: userMessage })
      });

      const data = await response.json();
      const answer = data.choices?.[0]?.message?.content || "æœªè¿”å›ä»»ä½•å†…å®¹";

      // âœ… åˆ†æ®µæ˜¾ç¤º AI å›ç­”
      const aiBubble = document.createElement("div");
      aiBubble.classList.add("ai-response");

      const segments = answer.split(/\n\s*\n|(?=^\s*[â‘ â‘¡â‘¢\d]+\.)|(?=^\s*[-Â·â€¢])/gm);
      segments.forEach(seg => {
        if (seg.trim()) {
          const para = document.createElement("p");
          para.textContent = seg.trim();
          aiBubble.appendChild(para);
        }
      });

      chatLog.appendChild(aiBubble);
      chatLog.scrollTop = chatLog.scrollHeight;
      statusArea.textContent = "âœ… åˆ†æå®Œæˆï¼Œæ¬¢è¿ç»§ç»­æé—®";
    } catch (err) {
      const errorBubble = document.createElement("p");
      errorBubble.textContent = "âŒ å‡ºé”™äº†ï¼š" + err.message;
      chatLog.appendChild(errorBubble);
      statusArea.textContent = "âŒ è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡çŠ¶æ€";
    }
  });

  // å±•å¼€/æ”¶èµ· AI å¯¹è¯åŒºï¼ˆæ³¨é‡Šæ‰ï¼‰
  // toggleChatLogBtn.addEventListener("click", () => {
  //   const currentMax = chatLog.style.maxHeight;
  //   if (!currentMax || currentMax === "250px") {
  //     chatLog.style.maxHeight = "none";
  //     toggleChatLogBtn.textContent = "æ”¶èµ·";
  //   } else {
  //     chatLog.style.maxHeight = "250px";
  //     toggleChatLogBtn.textContent = "å±•å¼€";
  //   }
  // });

  // å®æ—¶æ›´æ–°æ—¶é—´
  function updateCurrentTime() {
    const now = new Date();
    const options = {
      year: "numeric", month: "long", day: "numeric",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
      timeZoneName: "short"
    };
    document.getElementById("current-time").textContent =
      `å½“å‰æ—¶é—´ï¼š${now.toLocaleString("zh-CN", options)}`;
  }
  setInterval(updateCurrentTime, 1000);
  updateCurrentTime();
});
